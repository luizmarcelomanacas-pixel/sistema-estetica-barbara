name: Disparo Autom√°tico Agenda
on:
  schedule:
    # Roda todo dia √†s 10:00 UTC (07:00 Brasil)
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  acessar_agenda:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar Navegador
        run: |
          pip install playwright
          playwright install chromium

      - name: Abrir Site, Acordar e Disparar
        run: |
          python -c "
          from playwright.sync_api import sync_playwright
          import time

          # SEU LINK AQUI (Confira se est√° certo)
          LINK_DO_APP = 'https://sistema-estetica-barbara.streamlit.app/?rotina=disparar_email'

          with sync_playwright() as p:
              print('üöÄ Iniciando rob√¥...')
              browser = p.chromium.launch()
              page = browser.new_page()
              
              # TENTATIVA 1: Acordar o sistema
              print('Acessando o site (Tentativa 1)...')
              try:
                  page.goto(LINK_DO_APP, timeout=60000) # Espera at√© 90s carregar
                  time.sleep(15) 
              except:
                  print('Site demorou para responder (normal na hiberna√ß√£o).')

              # TENTATIVA 2: O Pulo do Gato (Refresh para for√ßar execu√ß√£o)
              print('üîÑ Recarregando para garantir o envio...')
              page.reload()
              
              # Espera o processamento final
              print('‚è≥ Aguardando envio do e-mail...')
              time.sleep(90) 
              
              # Tira um print para sabermos o que houve (se der erro de novo)
              page.screenshot(path='print_tela.png')
              
              content = page.content()
              if 'E-mail enviado' in content or 'Sucesso' in content:
                  print('‚úÖ SUCESSO: Mensagem de confirma√ß√£o encontrada na tela!')
              else:
                  print('‚ö†Ô∏è ALERTA: N√£o achei a mensagem de confirma√ß√£o. Verifique o print.')
                  
              browser.close()
          "
          
      - name: Salvar Print de Erro (Opcional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: print-da-tela
          path: print_tela.png
